name: Build Android APK
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.24.0' # Adjust this to your specific Flutter version if needed

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate Native Scaffolds & Update Configs
        run: |
          flutter create . --platforms=android --project-name silvargus
          python3 -c "
          import os, re
          
          # 1. Update Gradle Wrapper
          gw_path = 'android/gradle/wrapper/gradle-wrapper.properties'
          if os.path.exists(gw_path):
              with open(gw_path, 'r') as f: content = f.read()
              content = re.sub(r'distributionUrl=.*', 'distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-all.zip', content)
              with open(gw_path, 'w') as f: f.write(content)
                  
          # 2. Update AGP and Kotlin in settings.gradle
          sg_path = 'android/settings.gradle'
          if os.path.exists(sg_path):
              with open(sg_path, 'r') as f: content = f.read()
              content = re.sub(r'id\s+\"com\.android\.application\"\s+version\s+\".*?\"', 'id \"com.android.application\" version \"8.4.0\"', content)
              content = re.sub(r'id\s+\"org\.jetbrains\.kotlin\.android\"\s+version\s+\".*?\"', 'id \"org.jetbrains.kotlin.android\" version \"1.9.10\"', content)
              with open(sg_path, 'w') as f: f.write(content)
                  
          # 3. Update build.gradle (SDKs, NDK, Namespace, Desugaring)
          bg_path = 'android/app/build.gradle'
          if os.path.exists(bg_path):
              with open(bg_path, 'r') as f: content = f.read()
              content = re.sub(r'compileSdk\s*=\s*flutter\.compileSdkVersion', 'compileSdk = 35', content)
              content = re.sub(r'targetSdk\s*=\s*flutter\.targetSdkVersion', 'targetSdk = 35', content)
              content = re.sub(r'minSdk\s*=\s*flutter\.minSdkVersion', 'minSdk = 21', content)
              content = re.sub(r'compileSdkVersion\s+flutter\.compileSdkVersion', 'compileSdkVersion 35', content)
              content = re.sub(r'targetSdkVersion\s+flutter\.targetSdkVersion', 'targetSdkVersion 35', content)
              content = re.sub(r'minSdkVersion\s+flutter\.minSdkVersion', 'minSdkVersion 21', content)
              if 'namespace ' not in content:
                  content = re.sub(r'(android\s*\{)', r'\1\n    namespace \"com.silvargus.app\"', content)
              
              # NDK Version
              if 'ndkVersion' not in content:
                  content = re.sub(r'(android\s*\{)', r'\1\n    ndkVersion = \"25.1.8937393\"', content)
              
              # MultiDex Enabled
              if 'multiDexEnabled' not in content:
                  content = re.sub(r'(defaultConfig\s*\{)', r'\1\n        multiDexEnabled true', content)

              # Lint Options
              if 'lintOptions' not in content:
                  content = re.sub(r'(android\s*\{)', r'\1\n    lintOptions {\n        checkReleaseBuilds false\n        abortOnError false\n    }', content)

              # Core Library Desugaring Options
              if 'coreLibraryDesugaringEnabled' not in content:
                  content = re.sub(r'(compileOptions\s*\{)', r'\1\n        coreLibraryDesugaringEnabled true', content)
              
              # Desugaring Dependency
              if 'coreLibraryDesugaring ' not in content:
                  content = re.sub(r'(dependencies\s*\{)', r'\1\n    coreLibraryDesugaring \"com.android.tools:desugar_jdk_libs:2.0.4\"', content)
                  
              with open(bg_path, 'w') as f: f.write(content)
                  
          # 4. Suppress Warnings in gradle.properties
          gp_path = 'android/gradle.properties'
          with open(gp_path, 'a') as f: f.write('\nandroid.suppressUnsupportedCompileSdk=35\n')
          "
      - name: Build APK (Release)
        run: flutter build apk --release

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: silvargus-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
